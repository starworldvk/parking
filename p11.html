<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Manager Pro - Cloud Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #4361ee; --secondary: #3a0ca3; --success: #4cc9f0;
            --danger: #f72585; --warning: #f8961e; --info: #7209b7;
            --light: #f8f9fa; --dark: #212529; --gray: #6c757d; --light-gray: #e9ecef;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333; line-height: 1.6; min-height: 100vh; padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; filter: blur(0); transition: filter 0.3s; }
        
        /* --- ORIGINAL UI STYLES --- */
        header {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            color: var(--dark); padding: 25px 30px; text-align: center;
            border-radius: 20px; margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        header h1 {
            margin-bottom: 10px; font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .main-content { display: grid; grid-template-columns: 1fr 2fr; gap: 25px; }
        @media (max-width: 1100px) { .main-content { grid-template-columns: 1fr; } }
        
        .input-section, .records-section {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .section-title {
            color: var(--primary); margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray); display: flex; align-items: center; gap: 10px; font-size: 1.5rem;
        }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        input, select, textarea {
            width: 100%; padding: 14px 15px; border: 1px solid #ddd;
            border-radius: 10px; font-size: 16px; transition: all 0.3s; background: white;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none; padding: 14px 20px; border-radius: 10px;
            cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-danger { background: linear-gradient(135deg, #f72585, #b5179e); }
        .btn-success { background: linear-gradient(135deg, #4cc9f0, #4895ef); }
        .btn-warning { background: linear-gradient(135deg, #f8961e, #f3722c); }
        .btn-export { background: linear-gradient(135deg, #38b000, #2d7d46); }
        
        .time-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Stats Cards */
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card {
            background: white; padding: 25px 20px; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); text-align: center;
            border-top: 4px solid var(--primary); transition: all 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        
        /* Records Cards */
        .cards-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .record-card {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); border: 1px solid var(--light-gray);
            transition: all 0.3s; position: relative; overflow: hidden; animation: slideIn 0.3s ease-out;
        }
        .record-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .record-card::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: var(--primary); }
        .record-card.completed::before { background: var(--warning); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .car-number { font-size: 1.4rem; font-weight: 700; color: var(--dark); }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-active { background: rgba(76, 201, 240, 0.2); color: #4cc9f0; }
        .status-completed { background: rgba(248, 150, 30, 0.2); color: #f8961e; }
        
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid var(--light-gray); padding-bottom: 10px; }
        .detail-label { font-weight: 600; color: var(--gray); }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--light-gray); margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; background: #f8f9fa; border-radius: 10px 10px 0 0; margin-right: 5px; font-weight: 600; color: var(--gray); }
        .tab.active { background: white; color: var(--primary); border: 1px solid var(--light-gray); border-bottom: 1px solid white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Login Modal (Styled to match the theme) */
        #auth-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(33, 37, 41, 0.6); backdrop-filter: blur(8px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            background: rgba(255, 255, 255, 0.98); padding: 40px; border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2); width: 100%; max-width: 400px;
            text-align: center; border: 1px solid rgba(255,255,255,0.5);
        }
        .auth-box h2 { margin-bottom: 20px; color: var(--primary); font-size: 2rem; }
        
        /* Cloud Status */
        .settings-panel { margin-top: 25px; padding: 20px; background: #fef9e7; border-radius: 15px; border-left: 4px solid var(--warning); }
        .cloud-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 5px; }
        .cloud-indicator.connected { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }

        /* Animations */
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Print/Table */
        .table-view { display: none; overflow-x: auto; }
        .records-table { width: 100%; border-collapse: collapse; }
        .records-table th { background: var(--primary); color: white; padding: 15px; text-align: left; }
        .records-table td { padding: 15px; border-bottom: 1px solid var(--light-gray); }
        
        @media print {
            #auth-modal, header, .input-section, .export-controls, .view-toggle, button { display: none !important; }
            .main-content, .records-section, .table-view { display: block !important; width: 100%; }
            .cards-view { display: none; }
        }
    </style>
</head>
<body>

    <div id="auth-modal">
        <div class="auth-box">
            <h2><i class="fas fa-lock"></i> Login</h2>
            <p style="color: #666; margin-bottom: 20px;">Enter your credentials to access the system.</p>
            <form id="login-form">
                <div class="form-group">
                    <input type="email" id="login-email" placeholder="Email (e.g. admin@parking.com)" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-pass" placeholder="Password" required>
                </div>
                <button type="submit" style="width: 100%; justify-content: center;">
                    <i class="fas fa-sign-in-alt"></i> Access Dashboard
                </button>
                <p id="login-error" style="color: #f72585; margin-top: 15px; font-weight: 600; display: none;"></p>
            </form>
        </div>
    </div>

    <div class="container" id="app-content">
        <header>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1"></div> <div style="text-align:center;">
                    <h1><i class="fas fa-parking"></i> Parking Manager Pro</h1>
                    <p>Complete parking management with Cloud Sync</p>
                </div>
                <div style="flex:1; text-align:right;">
                    <button onclick="window.logout()" class="btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="input-section">
                <div class="tabs">
                    <div class="tab active" onclick="window.switchTab('manual')">Manual Entry</div>
                    <div class="tab" onclick="window.switchTab('voice')">Voice Command</div>
                </div>

                <div id="manual-tab" class="tab-content active">
                    <h2 class="section-title"><i class="fas fa-keyboard"></i> Add Record</h2>
                    <form id="parking-form">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>Car Number</label>
                            <input type="text" id="car-number" placeholder="e.g. ABC1234" required>
                        </div>
                        <div class="form-group">
                            <label>Place</label>
                            <input type="text" id="place" placeholder="e.g. Downtown Mall" required>
                        </div>
                        <div class="time-inputs">
                            <div class="form-group">
                                <label>Time In</label>
                                <input type="time" id="time-in" required>
                            </div>
                            <div class="form-group">
                                <label>Time Out</label>
                                <input type="time" id="time-out">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Price (₹)</label>
                            <input type="number" id="price" step="0.01" placeholder="e.g. 150">
                        </div>
                        <button type="submit" class="btn-success"><i class="fas fa-save"></i> Add Record</button>
                    </form>
                </div>

                <div id="voice-tab" class="tab-content">
                    <h2 class="section-title"><i class="fas fa-microphone"></i> Voice Command</h2>
                    <p style="color:var(--gray); margin-bottom:15px;">Click Start and speak: "Car ABC123 at Mall from 2 PM to 4 PM"</p>
                    
                    <div style="background:#f8f9fa; padding:20px; border-radius:15px; border-left:4px solid var(--primary); text-align:center;">
                        <button id="btn-start-voice" class="btn-success"><i class="fas fa-microphone"></i> Start</button>
                        <button id="btn-stop-voice" class="btn-danger" disabled><i class="fas fa-stop"></i> Stop</button>
                        <p id="voice-status" style="margin-top:10px; font-weight:bold;">Ready</p>
                        <p id="transcript" style="font-style:italic; margin-top:10px; color:#666;">...</p>
                    </div>
                    
                    <div id="voice-preview" style="display:none; margin-top:15px; background:#e8f6ef; padding:15px; border-radius:10px;">
                        <h4>Extracted Data:</h4>
                        <div id="voice-data-display"></div>
                        <button id="btn-confirm-voice" class="btn-success" style="margin-top:10px; width:100%">Confirm & Save</button>
                    </div>
                </div>

                <div class="settings-panel">
                    <h3><i class="fas fa-cloud"></i> Status</h3>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div id="cloud-dot" class="cloud-indicator"></div>
                        <span id="cloud-text">Connecting...</span>
                    </div>
                    <small id="user-display" style="display:block; margin-top:5px; color:var(--gray);"></small>
                </div>
            </div>

            <div class="records-section">
                <h2 class="section-title"><i class="fas fa-list-alt"></i> Parking Records</h2>
                
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-value" id="val-total">0</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="val-active">0</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="val-cost">₹0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>

                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; justify-content:space-between;">
                    <div style="flex:1; min-width:200px;">
                        <input type="text" id="search-box" placeholder="Search records..." onkeyup="window.renderRecords()">
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-export" onclick="window.exportCSV()" title="Export CSV"><i class="fas fa-file-csv"></i></button>
                        <button class="btn-export" onclick="window.exportExcel()" title="Export Excel"><i class="fas fa-file-excel"></i></button>
                        <button class="btn-export" onclick="window.exportPDF()" title="Export PDF"><i class="fas fa-file-pdf"></i></button>
                        <button class="btn-export" onclick="window.print()" title="Print"><i class="fas fa-print"></i></button>
                    </div>
                    <div style="background:var(--light-gray); padding:5px; border-radius:10px; display:flex;">
                        <button onclick="window.toggleView('cards')" style="padding:5px 10px; background:white; color:var(--primary); box-shadow:0 2px 5px rgba(0,0,0,0.1);"><i class="fas fa-th-large"></i></button>
                        <button onclick="window.toggleView('table')" style="padding:5px 10px; background:transparent; color:var(--gray);"><i class="fas fa-table"></i></button>
                    </div>
                </div>

                <div id="cards-view" class="cards-view">
                    </div>

                <div id="table-view" class="table-view">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Date</th><th>Car</th><th>Place</th><th>In</th><th>Out</th><th>Price</th><th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>

                <div id="no-data" style="text-align:center; padding:50px; color:var(--gray); display:none;">
                    <i class="fas fa-inbox" style="font-size:3rem; margin-bottom:15px; opacity:0.5;"></i>
                    <h3>No Records Found</h3>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, initializeFirestore, persistentLocalCache, CACHE_SIZE_UNLIMITED } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ---------------------------------------------------------
        // TODO: REPLACE WITH YOUR KEYS FROM FIREBASE CONSOLE
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCojQKXyizJhCDBWkzQ8eaV-7Q5R2-jSdo",

            authDomain: "parking-df117.firebaseapp.com",

            projectId: "parking-df117",

            storageBucket: "parking-df117.firebasestorage.app",

            messagingSenderId: "332938655028",

            appId: "1:332938655028:web:47ec9023056e942fab6161"
         
            
            // apiKey: "YOUR_API_KEY",
            // authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            // projectId: "YOUR_PROJECT_ID",
            // storageBucket: "YOUR_PROJECT_ID.appspot.com",
            // messagingSenderId: "YOUR_SENDER_ID",
            // appId: "YOUR_APP_ID"
        };

        // --- APP INITIALIZATION ---
        let db, auth;
        let records = [];
        let extractedVoiceData = null;
        let recognition;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            // Enable Offline Support
            db = initializeFirestore(app, {
                localCache: persistentLocalCache({ tabManager: undefined, cacheSizeBytes: CACHE_SIZE_UNLIMITED })
            });
        } catch(e) {
            console.error("Firebase Error:", e);
            document.getElementById('cloud-text').innerText = "Config Error";
            document.getElementById('cloud-dot').style.background = "red";
        }

        // --- AUTHENTICATION LOGIC ---
        onAuthStateChanged(auth, (user) => {
            const modal = document.getElementById('auth-modal');
            const container = document.getElementById('app-content');
            
            if (user) {
                modal.style.display = 'none';
                container.style.filter = 'blur(0)';
                document.getElementById('user-display').innerText = `Logged in as: ${user.email}`;
                initDataListener(); // Start syncing data
            } else {
                modal.style.display = 'flex';
                container.style.filter = 'blur(5px)';
                document.getElementById('cloud-text').innerText = "Waiting for login...";
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const errorEl = document.getElementById('login-error');
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(err) {
                errorEl.style.display = 'block';
                errorEl.innerText = "Login Failed: Invalid email or password.";
            }
        });

        window.logout = () => signOut(auth);

        // --- DATA LOGIC (FIRESTORE) ---
        function initDataListener() {
            document.getElementById('cloud-text').innerText = "Syncing...";
            const q = query(collection(db, "parkingRecords"), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderRecords();
                document.getElementById('cloud-text').innerText = "Online & Synced";
                document.getElementById('cloud-dot').classList.add('connected');
            }, (error) => {
                document.getElementById('cloud-text').innerText = "Offline Mode";
                document.getElementById('cloud-dot').classList.remove('connected');
                // Even if offline, Firebase will show cached data here automatically
            });
        }

        // --- UI FUNCTIONS ---
        window.renderRecords = () => {
            const search = document.getElementById('search-box').value.toLowerCase();
            const filtered = records.filter(r => 
                (r.carNumber || "").toLowerCase().includes(search) || 
                (r.place || "").toLowerCase().includes(search)
            );

            // Update Stats
            document.getElementById('val-total').innerText = records.length;
            document.getElementById('val-active').innerText = records.filter(r => r.status === 'active').length;
            const cost = records.reduce((sum, r) => sum + (parseFloat(r.price) || 0), 0);
            document.getElementById('val-cost').innerText = "₹" + cost.toFixed(2);

            const cardsEl = document.getElementById('cards-view');
            const tableEl = document.getElementById('table-body');
            const noDataEl = document.getElementById('no-data');

            if(filtered.length === 0) {
                cardsEl.innerHTML = ''; tableEl.innerHTML = '';
                noDataEl.style.display = 'block';
                return;
            }
            noDataEl.style.display = 'none';

            // Render Cards
            cardsEl.innerHTML = filtered.map(r => `
                <div class="record-card ${r.status}">
                    <div class="card-header">
                        <div class="car-number">${r.carNumber}</div>
                        <span class="status-badge status-${r.status}">${r.status.toUpperCase()}</span>
                    </div>
                    <div class="detail-row"><span class="detail-label">Place:</span> <span>${r.place}</span></div>
                    <div class="detail-row"><span class="detail-label">Date:</span> <span>${r.date}</span></div>
                    <div class="detail-row"><span class="detail-label">Time:</span> <span>${r.timeIn} - ${r.timeOut || '...'}</span></div>
                    <div class="detail-row"><span class="detail-label">Price:</span> <span>₹${r.price || 0}</span></div>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        ${r.status === 'active' ? `<button onclick="window.setOut('${r.id}')" class="btn-warning" style="flex:1">Set Out</button>` : ''}
                        <button onclick="window.deleteRec('${r.id}')" class="btn-danger" style="flex:1">Delete</button>
                    </div>
                </div>
            `).join('');

            // Render Table
            tableEl.innerHTML = filtered.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td><b>${r.carNumber}</b></td>
                    <td>${r.place}</td>
                    <td>${r.timeIn}</td>
                    <td>${r.timeOut || `<button onclick="window.setOut('${r.id}')" class="btn-warning" style="padding:5px;">Out</button>`}</td>
                    <td>₹${r.price || 0}</td>
                    <td><button onclick="window.deleteRec('${r.id}')" class="btn-danger" style="padding:5px;"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        // --- ACTIONS ---
        document.getElementById('parking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                date: document.getElementById('date').value,
                carNumber: document.getElementById('car-number').value.toUpperCase(),
                place: document.getElementById('place').value,
                timeIn: document.getElementById('time-in').value,
                timeOut: document.getElementById('time-out').value,
                price: document.getElementById('price').value,
                status: document.getElementById('time-out').value ? 'completed' : 'active',
                createdAt: new Date().toISOString(),
                user: auth.currentUser.email
            };
            await addDoc(collection(db, "parkingRecords"), data);
            e.target.reset();
            // Reset date to today
            document.getElementById('date').valueAsDate = new Date();
        });

        window.setOut = async (id) => {
            const now = new Date().toTimeString().slice(0,5);
            await updateDoc(doc(db, "parkingRecords", id), { timeOut: now, status: "completed" });
        }

        window.deleteRec = async (id) => {
            if(confirm("Are you sure?")) await deleteDoc(doc(db, "parkingRecords", id));
        }

        // --- UI HELPERS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if(tab === 'manual') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('manual-tab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('voice-tab').classList.add('active');
            }
        }

        window.toggleView = (view) => {
            if(view === 'cards') {
                document.getElementById('cards-view').style.display = 'grid';
                document.getElementById('table-view').style.display = 'none';
            } else {
                document.getElementById('cards-view').style.display = 'none';
                document.getElementById('table-view').style.display = 'block';
            }
        }

        // --- EXPORTS ---
        window.exportCSV = () => {
            let csv = "Date,Car Number,Place,Time In,Time Out,Price,Status\n";
            records.forEach(r => {
                csv += `${r.date},${r.carNumber},"${r.place}",${r.timeIn},${r.timeOut||''},${r.price},${r.status}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ParkingRecords.csv';
            a.click();
        }

        window.exportExcel = () => {
            const ws = XLSX.utils.json_to_sheet(records.map(r => ({
                Date: r.date, Car: r.carNumber, Place: r.place, In: r.timeIn, Out: r.timeOut, Price: r.price
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Parking");
            XLSX.writeFile(wb, "ParkingRecords.xlsx");
        }

        window.exportPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Parking Records", 14, 15);
            doc.autoTable({
                head: [['Date', 'Car', 'Place', 'In', 'Out', 'Price']],
                body: records.map(r => [r.date, r.carNumber, r.place, r.timeIn, r.timeOut||'-', r.price])
            });
            doc.save("ParkingRecords.pdf");
        }

        // --- VOICE RECOGNITION (Basic) ---
        if('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.onstart = () => document.getElementById('voice-status').innerText = "Listening...";
            recognition.onend = () => {
                document.getElementById('voice-status').innerText = "Stopped";
                document.getElementById('btn-start-voice').disabled = false;
                document.getElementById('btn-stop-voice').disabled = true;
            };
            recognition.onresult = (event) => {
                const txt = event.results[0][0].transcript;
                document.getElementById('transcript').innerText = txt;
                // Simple parser
                const carMatch = txt.match(/([a-z0-9]{4,})/i); 
                const priceMatch = txt.match(/(\d+)/);
                extractedVoiceData = {
                    date: new Date().toISOString().split('T')[0],
                    carNumber: carMatch ? carMatch[0].toUpperCase() : "UNKNOWN",
                    place: "General Parking",
                    timeIn: new Date().toTimeString().slice(0,5),
                    timeOut: "",
                    price: priceMatch ? priceMatch[0] : "",
                    status: "active",
                    createdAt: new Date().toISOString(),
                    user: auth.currentUser.email
                };
                document.getElementById('voice-preview').style.display = 'block';
                document.getElementById('voice-data-display').innerHTML = `<b>Car:</b> ${extractedVoiceData.carNumber} | <b>Price:</b> ${extractedVoiceData.price}`;
            };

            document.getElementById('btn-start-voice').onclick = () => {
                recognition.start();
                document.getElementById('btn-start-voice').disabled = true;
                document.getElementById('btn-stop-voice').disabled = false;
            };
            document.getElementById('btn-stop-voice').onclick = () => recognition.stop();
            document.getElementById('btn-confirm-voice').onclick = async () => {
                await addDoc(collection(db, "parkingRecords"), extractedVoiceData);
                document.getElementById('voice-preview').style.display = 'none';
                document.getElementById('transcript').innerText = "Saved!";
            };
        }

        // Set default date
        document.getElementById('date').valueAsDate = new Date();
    </script>
</body>
</html>